<head>
    <title>Early Retirement Calculator</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="importmap">
    {
      "imports": {
        "vue": "https://unpkg.com/vue@3.4.32/dist/vue.esm-browser.js"
      },
      "scopes": {}
    }
  </script>
    <style>
        @media print {
            .tab-content>.tab-pane {
                display: block;
                opacity: 100;
            }
        }

        b {
            text-decoration: underline;
            padding: 0 3 0 3;
        }

        label {
            margin-bottom: 4px;
        }

        div.col-4 {
            min-height: 80px
        }

        hr {
            margin-bottom: 30px;
        }

        tr.retirementAge td,
        .ssAge td,
        .medicareAge td,
        .noPenaltyAge td {
            font-weight: bold;
        }

        tr.rmdAge td {
            font-weight: bold;
            color: orange
        }

        td.spending,
        td.tax {
            color: red
        }

        h3 {
            margin-top: 30px
        }

        .accordion-button {
            font-weight: 555;
            text-decoration: underline;
        }

        .hidden {
            display: none
        }

        .negative {
            color: red
        }

        .positive {
            color: green
        }

        .tab-pane {
            padding: 20px;
        }
    </style>
    <script>
        // chart
        function updateChart() {
            const chartParent = document.getElementById('chartParent');
            chartParent.innerHTML = '';
            chartParent.style.display = 'none';
            chartParent.innerHTML = '<canvas id="chart1"></canvas>';
            chartParent.style.display = 'block';
            const yearlyData = JSON.parse(localStorage.getItem('data')).yearlyData;
            const labels = yearlyData.map(x => x.age);
            const data = {
                labels: labels,
                datasets: [{
                    label: 'Total Balance',
                    data: yearlyData.map(x => x.investment + x.roth + x.pretaxBalance),
                    borderColor: 'rgb(55, 255, 111)',
                    tension: 0.1
                }, {
                    label: 'Post-tax Balance',
                    data: yearlyData.map(x => x.investment),
                    borderColor: 'rgb(111, 192, 192)',
                    tension: 0.1
                }, {
                    label: 'Roth Balance',
                    data: yearlyData.map(x => x.roth),
                    borderColor: 'rgb(233, 192, 192)',
                    tension: 0.1
                },
                {
                    label: 'Pretax Balance',
                    data: yearlyData.map(x => x.pretaxBalance),
                    borderColor: 'rgb(75, 244, 192)',
                    tension: 0.1
                }
                ]
            };
            new Chart(
                document.getElementById('chart1'),
                {
                    type: 'line',
                    data: data,
                    options: {
                        scales: {
                            y: {
                                stacked: false
                            }
                        }
                    }
                }
            );
        }

    </script>
    <script>
        // adjust panel width
        function resetDivTab() {
            setDivTabClass('col-7');
        }
        function setDivTabClass(cla) {
            document.getElementById('divtabs').className = cla;
        }
    </script>
</head>

<body 1onload="document.getElementById('divRetirementYear').scrollIntoView();">
    <button id="btnReset" style="width:100%" class="btn btn-info"
        onclick="localStorage.clear();window.location.reload()">Data saved
        to your browser ONLY, click here to Reset</button>
    <div id="app" class="container-fluid">
        <h3>Early Retirement Calculator</h3> Click <a href="https://github.com/rzou9388/retire">here</a> for source code
        <hr />
        <div class="row">

            <div id="divtabs" class="col-7">
                <nav>
                    <div class="nav nav-tabs" id="nav-tab" role="tablist">
                        <button class="nav-link active" id="nav-home-tab" data-bs-toggle="tab"
                            data-bs-target="#nav-home" type="button" role="tab" aria-controls="nav-home"
                            aria-selected="true" onclick="resetDivTab()">Age</button>
                        <button class="nav-link" id="nav-income-tab" data-bs-toggle="tab" data-bs-target="#nav-income"
                            onclick="resetDivTab()" type="button" role="tab" aria-controls="nav-income"
                            aria-selected="false">Income &
                            Savings</button>
                        <button class="nav-link" id="nav-spending-tab" data-bs-toggle="tab" onclick="resetDivTab()"
                            data-bs-target="#nav-spending" type="button" role="tab" aria-controls="nav-spending"
                            aria-selected="false">Spending</button>
                        <button class="nav-link" id="nav-roth-tab" data-bs-toggle="tab" data-bs-target="#nav-roth"
                            onclick="resetDivTab()" type="button" role="tab" aria-controls="nav-roth"
                            aria-selected="false">Roth
                            Conversion</button>

                        <button class="nav-link" id="nav-taxes-tab" data-bs-toggle="tab" data-bs-target="#nav-taxes"
                            onclick="resetDivTab()" type="button" role="tab" aria-controls="nav-taxes"
                            aria-selected="false">Taxes &
                            Inflation</button>
                        <button class="nav-link" id="nav-yearly-tab" data-bs-toggle="tab" data-bs-target="#nav-yearly"
                            type="button" role="tab" aria-controls="nav-yearly" aria-selected="false"
                            onclick="setDivTabClass('col-12')">Yearly
                            Data</button>
                        <button class="nav-link" id="nav-info-tab" data-bs-toggle="tab" data-bs-target="#nav-info"
                            onclick="resetDivTab()" type="button" role="tab" aria-controls="nav-info"
                            aria-selected="false">Info</button>

                    </div>
                </nav>
                <div class="tab-content" id="nav-tabContent">
                    <div class="tab-pane fade show active" id="nav-home" role="tabpanel" aria-labelledby="nav-home-tab">
                        <div class="row">
                            <div class="col-4 ">
                                <label for="txtAge">Current Age:</label>
                                <input id="txtAge" class="form-control" v-model="data.person.age" step="1" type="number"
                                    @change="calculate" max="100" />
                            </div>
                            <div class="col-4">
                                <label for="data.person.retirement.age">Retirement Age:</label>
                                <input id="data.person.retirement.age" class="form-control"
                                    v-model="data.person.retirement.age" step="1" type="number" @change="calculate" />
                            </div>
                            <div class="col-4">
                                <label for="txtYears">Retire In Years:</label>
                                <input id="txtYears" class="form-control"
                                    :value="this.data.person.retirement.age - this.data.person.age" type="number"
                                    disabled />
                            </div>
                            <div class="col-4">
                                <label for="noPenaltyWithdraw.age">IRA no-penality withdraw age 59.5:</label>
                                <input id="noPenaltyWithdraw.age" class="form-control"
                                    :value="data.noPenaltyWithdraw.age" type="number" disabled />
                            </div>
                            <div class="col-4">
                                <label for="data.medicare.age">Medicare Age:</label>
                                <input id="data.medicare.age" class="form-control" :value="data.medicare.age"
                                    type="number" disabled />
                            </div>
                            <div class="col-4">Required Minimum Distribution Age<label for="rmd.age">:</label>
                                <input id="rmd.age" class="form-control" v-model="data.rmd.age" type="number"
                                    disabled />
                            </div>
                            <div class="col-4">
                                <label for="person.ss.age">Social Security Benefit Age (62-70):</label>
                                <input id="person.ss.age" class="form-control" v-model="data.person.ss.age"
                                    type="number" @change="calculate" min="62" max="70" />
                            </div>
                            <div class="col-4">
                                <label for="person.deceased.age">Life Expectancy (Age):</label>
                                <input id="person.deceased.age" class="form-control" v-model="data.person.deceased.age"
                                    type="number" @change="calculate" max="100" />
                            </div>
                        </div>
                        <div>
                            <h5>Summary</h5>
                            You are <b>{{data.person.age}}</b> years old,
                            you are planning to retire in <b>{{data.person.retirement.age-data.person.age}}</b>
                            years in <b>{{data.person.retirement.year}}</b> at the age of
                            <b>{{data.person.retirement.age}}</b> (beginning of the year).
                            You can start penalty free withdrawing from your traditional 401k/IRA accounts at
                            <b>{{data.noPenaltyWithdraw.age}}</b>(59.5), your medicare will kick in when you are
                            <b>{{data.medicare.age}}</b>, and your social security retirement benefit starts at
                            <b>{{data.person.ss.age}}</b>.
                            When you are
                            <b>{{data.rmd.age}}</b>, you'll be required to withdraw (RMD) from your traditional tax
                            deferred accounts (IRA, 401k).
                            Your life expectancy age is
                            <b>{{data.person.deceased.age}}</b>.
                            Your total number of years in retirement is
                            <b>{{data.person.deceased.age-data.person.retirement.age}}</b>.
                            <br />
                        </div>
                    </div>
                    <div class="tab-pane fade" id="nav-income" role="tabpanel" aria-labelledby="nav-income-tab">
                        <div class="row">
                            <h6>Current Savings (you and spouse)</h6>
                            <div class="col-4">
                                <label for="txtpretaxBalance" title="Traditional IRA, 401k, etc">Current Pretax Balance:
                                    {{toDollar(data.person.pretaxBalance)}}</label>
                                <input id="txtpretaxBalance" class="form-control" v-model="data.person.pretaxBalance"
                                    step="100" type="number" @change="calculate" />
                            </div>

                            <div class="col-4">
                                <label for="data.person.roth">Current Roth Balance:
                                    {{toDollar(data.person.roth)}}</label>
                                <input id="data.person.roth" class="form-control" v-model="data.person.roth"
                                    type="number" min="0" step="1000" @change="calculate" />
                            </div>
                            <div class="col-4">
                                <label for="data.person.investment">Current Post Tax Investment:
                                    {{toDollar(data.person.investment)}}</label>
                                <input id="data.person.investment" class="form-control" v-model="data.person.investment"
                                    type="number" min="1" step="1000" @change="calculate" />
                            </div>
                            <hr />
                            <div class="row">
                                <h6>Salary based income and savings (you and spouse)</h6>
                                <div class="col-4">
                                    <label for="data.person.salary">Current Combined Salary:
                                        {{toDollar(data.person.salary)}}</label>
                                    <input id="data.person.salary" class="form-control" v-model="data.person.salary"
                                        type="number" min="0" step="1000" @change="calculate" />
                                </div>
                                <div class="col-4">
                                    <label for="data.meritIncrease">Merit Increase:
                                        {{toPercent(data.meritIncrease)}}</label>
                                    <input id="data.meritIncrease" class="form-control" v-model="data.meritIncrease"
                                        type="number" min="1" step="1" @change="calculate" />
                                </div>
                            </div>

                            <div class="col-4">
                                <label for="contrib.employeePercent">Employee 401k Contribution:
                                    {{toPercent(data.contrib.employeePercent)}}</label>
                                <input id="contrib.employeePercent" class="form-control"
                                    v-model="data.contrib.employeePercent" type="number" min="1" step="1"
                                    @change="calculate" />
                            </div>
                            <div class="col-4">
                                <label for="contrib.roth401kPercent">Employee <b>Roth</b> 401k Contribution:
                                    {{toPercent(data.contrib.roth401kPercent)}}</label>
                                <input id="contrib.roth401kPercent" class="form-control"
                                    v-model="data.contrib.roth401kPercent" type="number" min="1" step="1"
                                    @change="calculate" />
                            </div>
                            <div class="col-4">
                                <label for="contrib.employerPercent">Employer 401k Match:
                                    {{toPercent(data.contrib.employerPercent)}}</label>
                                <input id="contrib.employerPercent" class="form-control"
                                    v-model="data.contrib.employerPercent" type="number" min="0" step="1"
                                    @change="calculate" />
                            </div>
                            <div class="col-4">
                                <label for="contrib.employerMatchUpTo">Employer 401k Match Up To:
                                    {{toPercent(data.contrib.employerMatchUpTo)}}</label>
                                <input id="contrib.employerMatchUpTo" class="form-control"
                                    v-model="data.contrib.employerMatchUpTo" type="number" min="0" max="10" step="1"
                                    @change="calculate" />
                            </div>
                        </div>
                        <hr />
                        <div class="row">
                            <h6>Social Security Benefits (you and spouse)</h6>

                            <div>check https://secure.ssa.gov/ for estimated SS Benefits</div>
                            <div class="col-4">
                                <label for="person.ss.age2">Social Security Benefit Age (62-70):</label>
                                <input id="person.ss.age2" class="form-control" v-model="data.person.ss.age"
                                    type="number" @change="calculate" min="62" max="70" />
                            </div>
                            <div class="col-4">
                                <label for="data.person.ss.perMonth">Monthly Benefit Amount:
                                    {{toDollar(data.person.ss.perMonth)}}</label>
                                <input id="data.person.ss.perMonth" class="form-control"
                                    v-model="data.person.ss.perMonth" type="number" step="100" @change="calculate" />
                            </div>
                            <div class="alert alert-warning">Current calculation assumes a single combined social
                                security benefit.</div>
                        </div>
                        <hr />
                        <div class="row">
                            <h6>Rate of return</h6>
                            <div class="col-4">
                                <label for="annualReturn.beforeRetirement">Annual Return Before Retirement:
                                    {{toPercent(data.annualReturn.beforeRetirement)}}</label>
                                <input id="annualReturn.beforeRetirement" class="form-control"
                                    v-model="data.annualReturn.beforeRetirement" type="number" min="1" step="1"
                                    @change="calculate" />
                            </div>
                            <div class="col-4">
                                <label for="annualReturn.afterRetirement">Annual Return After Retirement:
                                    {{toPercent(data.annualReturn.afterRetirement)}}</label>
                                <input id="annualReturn.afterRetirement" class="form-control"
                                    v-model="data.annualReturn.afterRetirement" type="number" min="1" step="1"
                                    @change="calculate" />
                            </div>
                        </div>
                        <hr />
                        <div id="divSalary">
                            <h5>Summary : Net worth
                                (<b>{{toDollar(data.person.roth+data.person.investment+data.person.pretaxBalance)}}</b>.)
                            </h5>
                            Your current household earned income is <b>{{toDollar(data.person.salary)}}</b>, you
                            expect annual
                            merit
                            increase of <b>{{toPercent(data.meritIncrease)}}</b>.
                            <div v-if="data.contrib.totalPercent > 0">
                                Your current tax deferred retirement accounts
                                have<b>{{toDollar(data.person.pretaxBalance)}}</b>, you are contributing
                                <b>{{toPercent(data.contrib.employeePercent)}}</b> of your
                                salary to 401k, and your employer contributes
                                <b>{{toPercent(data.contrib.employerPercent)}}</b> of
                                your contribution up to <b>{{toPercent(data.contrib.employerMatchUpTo)}}</b>, total
                                contribution is <b>{{toPercent(data.contrib.totalPercent)}}</b> of your
                                salary each year. Your current year 401k contribution calculates to be
                                <b>{{toDollar(data.person.salary*data.contrib.totalPercent/100)}}</b>.
                            </div>
                            <div v-if="data.contrib.rothTotalPercent > 0">
                                Your current Roth retirement accounts
                                have<b>{{toDollar(data.person.roth)}}</b>, you are contributing
                                <b>{{toPercent(data.contrib.roth401kPercent)}}</b> of your
                                salary to Roth 401k, and your employer contributes
                                <b>{{toPercent(data.contrib.employerPercent)}}</b> of
                                your contribution up to <b>{{toPercent(data.contrib.employerMatchUpTo)}}</b>, total
                                contribution is <b>{{toPercent(data.contrib.rothTotalPercent)}}</b> of your
                                salary each year. Your current year Roth 401k contribution calculates to be
                                <b>{{toDollar(data.person.salary*data.contrib.rothTotalPercent/100)}}</b>.
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="nav-spending" role="tabpanel" aria-labelledby="nav-spending-tab">
                        <div>
                            <div class="row">
                                <div class="col-4">
                                    <label for="data.spending.beforeRetirement">Yearly (Before Retirement)
                                        {{toDollar(data.spending.beforeRetirement)}}
                                    </label>
                                    <input id="data.spending.beforeRetirement" class="form-control"
                                        v-model="data.spending.beforeRetirement" type="number" step="10000"
                                        @change="calculate" />
                                </div>
                                <div class="col-4">
                                    <label for="data.spending.afterRetirement">Yearly (After Retirement)
                                        {{toDollar(data.spending.afterRetirement)}}
                                    </label>
                                    <input id="data.spending.afterRetirement" class="form-control"
                                        v-model="data.spending.afterRetirement" type="number" step="10000"
                                        @change="calculate" />
                                </div>
                                <div class="col-4">
                                    <label for="data.spending.insurance">Yearly Retirement Health Insurance (Before
                                        Medicare)
                                        {{toDollar(data.spending.insurance)}}
                                    </label>
                                    <input id="data.spending.insurance" class="form-control"
                                        v-model="data.spending.insurance" type="number" step="1000"
                                        @change="calculate" />
                                </div>
                                <div>
                                    Your estimated yearly spending <b>before</b> retirement is
                                    <b>{{toDollar(data.spending.beforeRetirement)}}</b>,
                                    monthly spending is <b>{{toDollar(data.spending.beforeRetirement/12)}}</b>,
                                    this should include:
                                    <ul>
                                        <li>Housing</li>
                                        <li>Your expensive kid(s) - tuition, activities, etc</li>
                                    </ul>
                                </div>
                                <div>
                                    Your estimated yearly spending <b>after</b> retirement is
                                    <b>{{toDollar(data.spending.afterRetirement)}}</b>, monthly spending is
                                    <b>{{toDollar(data.spending.afterRetirement/12)}}</b>:
                                    <ul>
                                        <li>Lower housing expenses, and hopefully no more mortgage</li>
                                        <li>Higher medical expenses</li>
                                        <li>More traveling</li>
                                    </ul>
                                </div>
                                <div>
                                    Your estimated starting Medicare year <b>{{data.medicare.year}}</b> cost based on
                                </div>
                                <div v-if="data.person.retirement.age < data.medicare.age">
                                    When you retire in <b>{{data.person.retirement.age-data.person.age}}</b> years at
                                    <b>{{data.person.retirement.age}}</b>,
                                    you are not yet qualified for Medicare, your estimated your monthly health insurance
                                    out
                                    of pocket before Medicare kicks in is
                                    <b>{{toDollar(data.spending.insurance/12)}}</b>.
                                </div>

                                <div class="mt-3">
                                    Your spending will be adjusted for <b>{{toPercent(data.inflation)}}</b> inflation
                                    every
                                    year.
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="nav-roth" role="tabpanel">
                        <div class="row">
                            <div class="col-4">
                                <label for="distribution.age">Age to start Roth Conversion
                                </label>
                                <input id="distribution.age" class="form-control" v-model="data.distribution.age"
                                    type="number" min="40" step="1" @change="calculate" />
                            </div>
                            <div class="col-4">
                                <label for="distribution.braket"
                                    title="Projected retirement age tax brackets shown">Conversion based on tax
                                    bracket</label>
                                <select id="distribution.braket" @change="calculate" class="form-select"
                                    v-model="data.distribution.bracket">
                                    <option value="0">0%</option>
                                    <option v-for="b in getTaxBracketsForYear(data.distribution.year).data"
                                        :value="b.percent">{{b.percent}}% -
                                        {{toDollar(b.income)}}</option>
                                </select>
                            </div>
                            <div class="col-4">
                                <label for="distribution.offset" title="">- or + $ amount from the bracket</label>
                                <input id="distribution.offset" @change="calculate" class="form-control" type="number"
                                    step="1000" v-model="data.distribution.offset" />
                            </div>
                        </div>
                        <div class="mt-3">
                            <h5>Required Minimum Distribution <b>{{data.rmd.year}}</b> (age <b>{{data.rmd.age}}</b>)
                            </h5>
                            <div class="mt-3">
                                When you reach the age of <b>{{data.rmd.age}}</b>, you'll be required to take "Required
                                Minimum Distribution" from your tax deferred traditional 401k/IRA accounts, and
                                distribution is taxed at the ordinary income rate.
                            </div>
                            <div class="mt-3">
                                The 'ordinary income' also means that you'll have taxable income, which affects the
                                tax you pay,
                                your Medicare payment, and Social Security retirement benefit taxes. However,
                                there are some tax benefits of keeping some money in the tax-deferred accounts,
                                you want the amount to be low enough that you won't be forced to take out a lot each
                                year.
                                The RMD money you are forced to take out cannot be directly converted to Roth IRA. The
                                IRS requires that you take the RMD for the year before you can perform a Roth
                                conversion.
                            </div>
                            <div class="mt-3">
                                The strategy is to convert your traditional 401k/IRA to Roth IRA as early as possible
                                (typically after you retire),
                                you'll pay taxes for the years of conversion; once converted, your roth balance,
                                including
                                gains, won't be taxed again, and there's no required minimum distribution, nor will your
                                withdraws from Roth count as taxable income.
                            </div>
                            <div class="mt-3">
                                Your Roth conversion starts at <b>{{data.distribution.age}}</b>, and
                                fills up the <b>{{toPercent(data.distribution.bracket)}}</b>tax bracket;
                                <span v-if="data.yearlyData.find(x => x.pretaxBalance == 0)">at
                                    <b>{{data.yearlyData.find(x => x.pretaxBalance == 0).age-1}}</b>, your tax deferred
                                    accounts will have <b>$0.00</b></span>

                                at <b>{{data.rmd.age}}</b>, your tax
                                deferred accounts will have <b>{{toDollar(data.rmd.pretaxBalance)}}</b>.
                                <div v-if="data.rmd.pretaxBalance>0">
                                    you'll be required to withdraw <b>{{toDollar(data.rmd.pretaxBalance)}}</b> / 27.4 =
                                    <b>{{toDollar(data.rmd.rmd)}}</b> on first year and increases percentage wise every
                                    year
                                    after. Your tax bill on that first year distribution is around
                                    <b>{{toDollar(calculateOrdinaryIncomeTaxForYear(this.data.rmd.rmd,
                                        this.data.rmd.year))}}</b>.
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="nav-taxes" role="tabpanel">
                        <div class="row">
                            <div class="col-4">
                                <label for="data.tax.state.beforeRetirement">State Tax (Before Retirement)
                                    {{toPercent(data.tax.state.beforeRetirement)}}
                                </label>
                                <input id="data.tax.state.beforeRetirement" class="form-control"
                                    v-model="data.tax.state.beforeRetirement" type="number" min="0" step="1"
                                    @change="calculate" />
                            </div>
                            <div class="col-4">
                                <label for="data.tax.state.afterRetirement">State Tax (After Retirement)
                                    {{toPercent(data.tax.state.afterRetirement)}}
                                </label>
                                <input id="data.tax.state.afterRetirement" class="form-control"
                                    v-model="data.tax.state.afterRetirement" type="number" min="0" step="1"
                                    @change="calculate" />
                            </div>
                            <div class="col-4">
                                <label for="inflation">Inflation {{toPercent(data.inflation)}}</label>
                                <input id="inflation" class="form-control" v-model="data.inflation" type="number"
                                    step="1" @change="calculate" />
                            </div>
                        </div>
                        <div>
                            <h5>Taxes</h5>
                            <div class="mt-3">
                                <ul>
                                    <li>Federal Ordinary Income Tax (see table below) - with historical 1.7% increase in
                                        bracket
                                        ceilings each year</li>
                                    <li>Federal Capital Gain Tax (0%/15%/20%/23.8% for long term)</li>
                                    <li>FICA (SS & Medicare), 6.2%, and extra 0.9% for portion of salary income over
                                        $250,000;
                                        no FICA on capital gains or roth conversion.</li>
                                    <li>Medicare Surtax 3.8% on Capital Gain for MAGI over $250,000.</li>
                                    <li>State Taxes allows different taxes for before and after retirement.</li>
                                    <li>Long-term capital gains can't push you into a higher tax bracket</li>
                                </ul>
                            </div>
                            <div class="mt-3">
                                <h6>Social Security benefits tax: </h6>
                                Depending on your 'provisional income', 0%-85% of SSN income is taxed.
                                'Provisional income' includes gross income (wages, interest, dividend, pension, rent
                                income), tax-free interest (municipal bond) and 1/2 of SS Benefits.
                                <ul>
                                    <li>
                                        For single filer (tax): if provisional income is less than 25000, 0%; between
                                        25000 and 34000, then 50%, above 34000 = 85%.
                                    </li>
                                    <li>
                                        Married Filing Jointly: less than 32,000 = 0%, between 32000 and 44000 = 50%, >
                                        44000, then 85%.
                                    </li>
                                    <li>Note: provisional income is not inflation adjusted.</li>
                                </ul>
                                The resulting percentage of SS Benefits is subject to ordinary income tax rate.
                                <br />
                                Note: The calculation assumes there's no state tax for SS benefits.
                                <br />
                                Note: Roth IRA distributions are not included in the provisional income calculation.
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="nav-yearly" role="tabpanel">
                        <div class="row">
                            <div class="form-check col-1">
                                <input class="form-check-input" id="col-age" type="checkbox" @change="saveState"
                                    v-model="data.columns.age" />
                                <label class="form-check-label" for="col-age">Age</label>
                            </div>
                            <div class="form-check col">
                                <input class="form-check-input" id="col-year" type="checkbox"
                                    v-model="data.columns.year" />
                                <label class="form-check-label" for="col-year">Year</label>
                            </div>
                            <div class="form-check col">
                                <input class="form-check-input" id="col-salary" type="checkbox"
                                    v-model="data.columns.salary" />
                                <label class="form-check-label" for="col-salary">Salary</label>
                            </div>
                            <div class="form-check col">
                                <input class="form-check-input" id="col-contrib" type="checkbox"
                                    v-model="data.columns.contrib" />
                                <label class="form-check-label" for="col-contrib">401K
                                    Contrib {{toPercent(data.contrib.totalPercent)}}</label>
                            </div>
                            <div class="form-check col">
                                <input class="form-check-input" id="col-contribRoth" type="checkbox"
                                    v-model="data.columns.contribRoth" />
                                <label class="form-check-label" for="col-contribRoth">Roth 401K
                                    {{toPercent(data.contrib.rothTotalPercent)}}</label>
                            </div>
                            <div class="form-check col">
                                <input class="form-check-input" id="col-rmd" type="checkbox"
                                    v-model="data.columns.rmd" />
                                <label class="form-check-label" for="col-rmd"
                                    title="Required Minimum Distribution">RMD</label>
                            </div>
                            <div class="form-check col">
                                <input class="form-check-input" id="col-spending" type="checkbox"
                                    v-model="data.columns.spending" />
                                <label class="form-check-label" for="col-spending">Spending</label>
                            </div>
                            <div class="form-check col">
                                <input class="form-check-input" id="col-dist" type="checkbox"
                                    v-model="data.columns.dist" />
                                <label class="form-check-label" for="col-dist">Roth Conversion</label>
                            </div>
                            <div class="form-check col">
                                <input class="form-check-input" id="col-pretax" type="checkbox"
                                    v-model="data.columns.pretax" />
                                <label title="traditional 401k, IRA, etc" class="form-check-label" for="col-pretax">Tax
                                    Deferred Balance</label>
                            </div>
                            <div class="form-check col">
                                <input class="form-check-input" id="col-roth" type="checkbox"
                                    v-model="data.columns.roth" />
                                <label class="form-check-label" for="col-roth">Roth</label>
                            </div>
                            <div class="form-check col">
                                <input class="form-check-input" id="col-investment" type="checkbox"
                                    v-model="data.columns.investment" />
                                <label class="form-check-label" for="col-investment">Investment</label>
                            </div>
                            <div class="form-check col">
                                <input class="form-check-input" id="col-medicare" type="checkbox"
                                    v-model="data.columns.medicare" />
                                <label class="form-check-label" for="col-medicare">MedicareB Prem</label>
                            </div>
                            <div class="form-check col">
                                <input class="form-check-input" id="col-ss" type="checkbox" v-model="data.columns.ss" />
                                <label class="form-check-label" for="col-ss">Social Seurity</label>
                            </div>
                            <div class="form-check col">
                                <input class="form-check-input" id="col-tax" type="checkbox"
                                    v-model="data.columns.tax" />
                                <label class="form-check-label" for="col-tax">Taxes</label>
                            </div>
                        </div>

                        <table class="table table-strip table-hover mt-1">
                            <thead>
                                <th v-if="data.columns.age">Age</th>
                                <th v-if="data.columns.year">Year</th>
                                <th v-if="data.columns.salary">Salary</th>
                                <th v-if="data.columns.contrib">401k Contrib</th>
                                <th v-if="data.columns.contribRoth">Roth 401k Contrib</th>
                                <th title="Required Minimum Distribution" v-if="data.columns.rmd">RMD</th>
                                <th v-if="data.columns.spending" title="inflation adjusted">Spending
                                </th>
                                <th v-if="data.columns.dist">Roth Conversion</th>
                                <th v-if="data.columns.pretax" title="traditional 401k, IRA">Tax
                                    Deferred Balance</th>
                                <th v-if="data.columns.roth">Roth Balance</th>
                                <th v-if="data.columns.investment" title="post-tax brokerage + savings">
                                    Investment
                                </th>
                                <th v-if="data.columns.medicare">Medicare</th>
                                <th v-if="data.columns.ss">Social Security</th>
                                <th title="FICA, Federal, State, Ordinary Income and Capital Gains"
                                    v-if="data.columns.tax">
                                    Taxes</th>
                            </thead>
                            <tbody>
                                <tr v-for="yearly in data.yearlyData" :class="{
                                            retirementAge:yearly.age===data.person.retirement.age,
                                            rmdAge:yearly.age ===data.rmd.age,
                                            medicareAge:yearly.age === data.medicare.age,
                                            ssAge:yearly.age === data.person.ss.age,
                                            noPenaltyAge:yearly.age === data.noPenaltyWithdraw.age
                                        }" :title="yearly.title">
                                    <td v-if="data.columns.age">{{yearly.age}}</td>
                                    <td v-if="data.columns.year">{{yearly.year}}</td>
                                    <td v-if="data.columns.salary">{{toDollar(yearly.salary)}}</td>
                                    <td v-if="data.columns.contrib">{{toDollar(yearly.k401)}}</td>
                                    <td v-if="data.columns.contribRoth">{{toDollar(yearly.roth401k)}}</td>
                                    <td v-if="data.columns.rmd">{{toDollar(yearly.rmd)}}</td>
                                    <td v-if="data.columns.spending" class="spending">
                                        -{{toDollar(yearly.spending)}}</td>
                                    <td v-if="data.columns.dist">{{toDollar(yearly.dist)}}</td>
                                    <td v-if="data.columns.pretax">
                                        <span
                                            :class="{negative:yearly.pretaxBalance <0,positive:yearly.pretaxBalance>0}">
                                            {{toDollar(yearly.pretaxBalance)}}</span>
                                    </td>
                                    <td v-if="data.columns.roth">
                                        <span
                                            :class="{negative:yearly.roth <0,positive:yearly.roth>0}">{{toDollar(yearly.roth)}}</span>
                                    </td>
                                    <td v-if="data.columns.investment">
                                        <span :class="{negative:yearly.investment <0,positive:yearly.investment>0}">
                                            {{toDollar(yearly.investment)}}</span>
                                    </td>
                                    <td v-if="data.columns.medicare"><span
                                            :class="{negative:yearly.medicare>0}">-{{toDollar(yearly.medicare)}}</span></span>
                                    </td>
                                    <td v-if="data.columns.ss"><span
                                            :class="{positive:yearly.ss>0}">{{toDollar(yearly.ss)}}</span>
                                    </td>
                                    <td v-if="data.columns.tax"><span :class="{negative:yearly.tax>0}"
                                            :title="JSON.stringify(getTaxBracketsForYear(yearly.year).data)">-{{toDollar(yearly.tax)}}</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="tab-pane fade" id="nav-info">
                        <details>
                            <summary>Projected Tax Rates</summary>
                            <div class="row">
                                Calculated with historical 1.7% increase in bracket ceilings each year, and accounted
                                for 2025 trump tax (Tax Cuts and Jobs Act) brackets.
                                <table class="table table-hover table-strip">
                                    <thead>
                                        <tr>
                                            <th>Year</th>
                                            <th>Rate</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr
                                            v-for="y in data.tax.brackets.filter(x => x.year >= (new Date()).getFullYear())">
                                            <td>{{y.year}}</td>
                                            <td>
                                                <table>
                                                    <tr v-for="b in y.data">
                                                        <td>{{toPercent(b.percent)}}</td>
                                                        <td>{{toDollar(b.income)}}</td>
                                                    </tr>
                                                </table>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </details>

                    </div>
                </div>
            </div>
            <div class="col-5">
                <h4>Summary</h4>
                <div id="chartParent" style="height:450px;display:none"></div>
                <div id="divCurrentYear" class="mt-3">
                    <h6>Current year <b>{{new Date().getFullYear()}}</b> (age
                        <b>{{data.person.age}}</b>)
                    </h6>
                    Your current net worth is
                    (<b>{{toDollar(data.person.roth+data.person.investment+data.person.pretaxBalance)}}</b>.)

                </div>
                <hr />
                <div id="divRetirementYear">
                    <h6>Retirement year <b>{{data.person.retirement.year}}</b> (age
                        <b>{{data.person.retirement.age}}</b>)
                    </h6>
                    When you retire, your net worth will be
                    <b>{{toDollar(data.person.retirement.roth+data.person.retirement.pretaxBalance+data.person.retirement.investment)}}</b>:
                    you'll have <b>{{toDollar(data.person.retirement.investment)}}</b> in your post-tax
                    investment accounts,
                    <b>{{toDollar(data.person.retirement.roth)}}</b> in your Roth IRA/401k accounts, and
                    <b>{{toDollar(data.person.retirement.pretaxBalance)}}</b> in your tax deferred
                    traditional retirement accounts.
                    <div v-if="data.person.retirement.investment<0" class="alert alert-danger mt-3">
                        Your current retirement plan cannot get you to <b>{{data.person.retirement.age}}</b>,
                        your post-tax balance will be
                        <b>{{toDollar(data.person.retirement.investment)}}</b>,
                        try adjusting your retirement plan!
                    </div>

                    After retirement, all your spending, including taxes that you
                    need to pay
                    will come from your post-tax investment account until you reach the age of
                    <b>{{data.noPenaltyWithdraw.age}}</b>,
                    which means that you'll need to pay capital gain taxes for the amount drawn.
                    <div class="alert">Note: the calculation assumes 50% withdraws from post-tax investment
                        accounts are capital gains<br />
                        Note: For ease of calculation, age 60 is used, instead of 59.5</div>
                </div>
                <hr />

                <div id="divWithdrawLogic" class="mt-3">
                    <h6>Penalty free withdraw year <b>{{data.noPenaltyWithdraw.year}}</b>
                        (age <b>{{data.noPenaltyWithdraw.age}}</b>)
                    </h6>
                    <div class="mt-3">
                        After you've reached the age of <b>{{data.noPenaltyWithdraw.age}}</b> (59.5),
                        your net worth will be
                        <b>{{toDollar(data.noPenaltyWithdraw.roth+data.noPenaltyWithdraw.pretaxBalance+data.noPenaltyWithdraw.investment)}}</b>:
                        you'll have <b
                            :class="{'negative':data.noPenaltyWithdraw.investment<0}">{{toDollar(data.noPenaltyWithdraw.investment)}}</b>
                        in your post-tax investment account,
                        <b>{{toDollar(data.noPenaltyWithdraw.roth)}}</b> in your Roth IRA/401k accounts, and
                        <b>{{toDollar(data.noPenaltyWithdraw.pretaxBalance)}}</b> in your tax deferred
                        traditional retirement accounts.
                        <br />
                        You can start
                        withdrawing funds from pretax accounts without penalty,
                        however, you'll pay ordinary income tax for the withdraws.
                        At this time, instead of selling investments from post-tax accounts to cover taxes and
                        spending, the funds
                        should come from your pretax accounts. The step-up rule allows you to pass down your
                        brokerage investment balance to your heir without incurring capital gain tax.
                    </div>
                    <div v-if="data.noPenaltyWithdraw.investment<0" class="alert alert-danger mt-3">
                        Your current retirement plan cannot get you through
                        <b>{{data.noPenaltyWithdraw.age}}</b>
                        where you can withdraw from pretax accounts without penalty.
                        Your post-tax savings is <b>{{toDollar(data.noPenaltyWithdraw.investment)}}</b>,
                        You have <b>{{toDollar(data.noPenaltyWithdraw.pretaxBalance)}}</b> in pretax accounts,
                        consider adjusting your plan, or look into "55 rule" or "72t" for early withdraw.
                    </div>
                </div>
                <div class="mt-3">
                    <h6>Social Security benefit starting year <b>{{data.person.ss.year}}</b>
                        (age <b>{{data.person.ss.age}}</b>)</h6>

                    You indicated that you want to start receiving the social security benefit at the age of
                    <b>{{data.person.ss.age}}</b>, and the monthly benefit will be
                    <b>{{toDollar(data.person.ss.perMonth)}}</b>.
                </div>
                <hr />

                <div class="mt-3">
                    <h6>Required Minimum Distribution year <b>{{data.rmd.year}}</b> (age
                        <b>{{data.rmd.age}})</b>
                    </h6>
                    Your pretax retirement accounts will have <b>{{toDollar(data.rmd.pretaxBalance)}}</b>
                    <div class="alert" v-if="data.rmd.pretaxBalance<500000">Good Job</div>
                    <div class="alert" v-if="data.rmd.pretaxBalance>500000">You'll be required to take out
                        <b>{{toDollar(data.rmd.rmd)}}</b> from your pretax accounts this year, your
                        estimated
                        tax bill
                        will be
                        <b class="negative">{{toDollar(data.rmd.tax)}}</b> for withdraw amount of
                        <b>{{toDollar(data.rmd.dist)}}</b>.
                    </div>
                </div>
                <hr />

                <div class="mt-3">
                    <h6>End of life year <b>{{data.person.deceased.year}}</b> (age
                        <b>{{data.person.deceased.age}}</b>)
                    </h6>
                    When you die, your net worth will be
                    <b>{{toDollar(data.person.deceased.roth+data.person.deceased.pretaxBalance+data.person.deceased.investment)}}</b>:

                    you'll have <b>{{toDollar(data.person.deceased.investment)}}</b> in your post-tax
                    investment accounts,
                    <b>{{toDollar(data.person.deceased.roth)}}</b> in your Roth IRA/401k accounts, and
                    <b>{{toDollar(data.person.deceased.pretaxBalance)}}</b> in your tax deferred
                    traditional retirement accounts.
                </div>
                <hr />

                <div class="alert alert-info">Tip: How much money you will end up with is what matters, not how
                    much taxes you will pay.
                </div>
            </div>
        </div>
    </div>
</body>
<script type="module">
    import { createApp } from "vue";
    const app = createApp({
        data() {

            let savedData = JSON.parse(localStorage.getItem("data"));
            if (savedData) {
                savedData.tax.brackets = [];
                savedData.medicare.premiums = [];
                savedData.yearlyData = [];
                return { data: savedData };
            }

            // lifetimetable used to calculate how much rmd for age
            // https://www.irs.gov/publications/p590b#en_US_2021_publink100090093
            const uniformLifetimeTable = [
                [72, 27.4], [73, 26.5], [74, 25.5], [75, 24.6], [76, 23.7], [77, 22.9], [78, 22], [79, 21.1], [80, 20.2], [81, 19.4], [82, 18.5],
                [83, 17.7], [84, 16.8], [85, 16], [86, 15.2], [87, 14.4], [88, 13.7], [89, 12.9], [90, 12.2], [91, 11.5], [92, 10.8],
                [93, 10.1], [94, 9.5], [95, 8.9], [96, 8.4], [97, 7.8], [98, 7.3], [99, 6.8], [100, 6.4]
            ];

            // initial data
            return {
                data: {
                    columns: {
                        age: true, year: true, salary: true, contrib: true, contribRoth: false,
                        rmd: true, spending: true, dist: true, pretax: true, roth: true, investment: true, ss: true,
                        medicare: true, tax: true
                    },
                    yearlyData: [],
                    spending: { beforeRetirement: 80000, afterRetirement: 70000, insurance: 20000 },
                    annualReturn: { beforeRetirement: 12, afterRetirement: 6 },
                    distribution: { age: 60, amount: 0, bracket: 15, offset: 0 },
                    noPenaltyWithdraw: { age: 60 },
                    inflation: 3.0,
                    meritIncrease: 2,
                    medicare: { age: 65, premiums: [] },
                    rmd: { age: 75, pretaxBalance: 0, year: 0, lifetimeTable: uniformLifetimeTable },
                    contrib: {  // retirement acct contrib
                        employeePercent: 6, employerPercent: 50, totalPercent: 0,
                        roth401kPercent: 0, rothTotalPercent: 0, employerMatchUpTo: 6
                    },
                    person: {
                        age: 50, pretaxBalance: 500000, salary: 150000,
                        retirement: {
                            age: 60,
                            year: 0,
                            salary: 0,
                            pretaxBalance: 0
                        },
                        deceased: {
                            age: 88
                        },
                        investment: 100000,
                        roth: 100000,
                        ss: { age: 62, perMonth: 3000 }
                    },
                    tax: { brackets: [], state: { beforeRetirement: 5, afterRetirement: 0 } }
                }
            }
        },

        methods: {

            calculate() {

                this.data.contrib.totalPercent = this.calculateTotal401kWithMatch(this.data.contrib.employeePercent, this.data.contrib.employerPercent, this.data.contrib.employerMatchUpTo);
                this.data.contrib.rothTotalPercent = this.calculateTotal401kWithMatch(this.data.contrib.roth401kPercent, this.data.contrib.employerPercent, this.data.contrib.employerMatchUpTo);

                this.calculateYearly();

                this.saveState();

                this.data.rmd = this.mergeYearlyDataByAge(this.data.rmd);

                this.data.person.retirement = this.mergeYearlyDataByAge(this.data.person.retirement);

                this.data.distribution = this.mergeYearlyDataByAge(this.data.distribution);

                this.data.person.deceased = this.mergeYearlyDataByAge(this.data.person.deceased);

                this.data.noPenaltyWithdraw = this.mergeYearlyDataByAge(this.data.noPenaltyWithdraw);

                this.data.medicare = this.mergeYearlyDataByAge(this.data.medicare);

                window.setTimeout(updateChart, 200);
            },
            mergeYearlyDataByAge(originalData) {
                const oneYearData = this.data.yearlyData.find(y => y.age === originalData.age);
                const merged = { ...originalData, ...oneYearData };
                return merged;
            },
            /**
             * ex: employer = 7%, employer = 50% up to 6%, total = 10
             */
            calculateTotal401kWithMatch(employeePercent, employerPercent, matchUpToPercent) {
                const adjustedEmployeePercent = employeePercent > matchUpToPercent ? matchUpToPercent : employeePercent;
                return employeePercent + adjustedEmployeePercent * (employerPercent / 100);

            },
            saveState() {
                localStorage.setItem("data", JSON.stringify(this.data));
            },
            calculateCompound(val, rate, years, extraContrib = 0) {
                for (let i = 0; i < years; i++) {
                    val = val * (1 + rate / 100) + extraContrib;
                }
                return val;
            },
            calculateGain(ignoreRate, amount, rate) {
                if (ignoreRate) {
                    return amount;
                }
                if (amount < 0) {
                    return amount;
                }
                return amount * (1 + rate / 100);
            },
            calculateYearly() {
                this.data.yearlyData = [];
                const yearsToCalc = this.data.person.deceased.age - this.data.person.age;
                let age = this.data.person.age;
                let year = (new Date()).getFullYear();
                let pretaxBalance = this.data.person.pretaxBalance;
                let salary = this.data.person.salary;
                let investment = this.data.person.investment;
                let roth = this.data.person.roth;
                let spending = { beforeRetirement: this.data.spending.beforeRetirement, afterRetirement: this.data.spending.afterRetirement };

                for (let i = 0; i <= yearsToCalc; i++) {
                    const title = this.getRowTitle(age);

                    let spendingAmount = 0;
                    //before retirement
                    if (age < this.data.person.retirement.age) {
                        salary = this.calculateGain(i === 0, salary, this.data.meritIncrease);
                        pretaxBalance = this.calculateGain(i === 0, pretaxBalance, this.data.annualReturn.beforeRetirement);
                        investment = this.calculateGain(i === 0, investment, this.data.annualReturn.beforeRetirement);
                        roth = this.calculateGain(i === 0, roth, this.data.annualReturn.beforeRetirement);
                        spendingAmount = spending.beforeRetirement;
                    } else { // after retirement
                        salary = 0;
                        pretaxBalance = this.calculateGain(i === 0, pretaxBalance, this.data.annualReturn.afterRetirement);
                        investment = this.calculateGain(i === 0, investment, this.data.annualReturn.afterRetirement);
                        roth = this.calculateGain(i === 0, roth, this.data.annualReturn.afterRetirement);
                        spendingAmount = spending.afterRetirement;
                        if (age < this.data.medicare.age) {
                            spendingAmount += this.calculateInsuranceSpendingForYear(year);
                        }
                    }

                    // 401k
                    const k401 = salary * (this.data.contrib.totalPercent / 100);
                    const k401Employee = salary * (this.data.contrib.employeePercent / 100);    // for taking it out of savings
                    const roth401k = salary * (this.data.contrib.rothTotalPercent / 100);
                    const roth401kEmployee = salary * (this.data.contrib.roth401kPercent / 100);

                    let taxableEarnedIncome = salary - k401Employee;
                    let taxableOrdinaryIncome = taxableEarnedIncome; // includes roth conversions

                    // rmd age 75+ after 2035
                    let rmd = 0;
                    if (age >= this.data.rmd.age) {
                        rmd = pretaxBalance / (this.data.rmd.lifetimeTable.find(x => x[0] === age)[1]);
                    }

                    //** calculate how much to convert
                    let dist = 0;
                    if (pretaxBalance > 0 && age >= this.data.distribution.age) {
                        const bracket = this.data.distribution.bracket;
                        const totalDistAllowed = this.getIncomeForBracketAndYear(year, bracket) - taxableOrdinaryIncome + this.data.distribution.offset;
                        if (pretaxBalance < totalDistAllowed) {
                            dist = pretaxBalance;
                        } else {
                            dist = totalDistAllowed;
                        }

                        // if rmd is greater than calculated distribution amount, then take out RMD
                        dist = rmd > dist ? rmd : dist;

                        // dist taxed at ordinary income
                        taxableOrdinaryIncome += dist;
                    }

                    const ss = this.calculateSSBenefits(age);
                    let spendingAfterSS = spendingAmount - ss;

                    // ===========  taxes
                    const fica = this.calculateFica(salary, year); // fica only on salary
                    const taxableSS = this.calculateSSToTax(taxableEarnedIncome, ss);
                    const ordinaryIncomeTax = this.calculateOrdinaryIncomeTaxForYear(taxableOrdinaryIncome + taxableSS, year);
                    let tax = ordinaryIncomeTax;
                    tax += fica;

                    const capitalGainTax = this.calculateCapitalGainTax(age, year, tax, dist, spendingAfterSS, investment);
                    tax += capitalGainTax;

                    let stateTax = 0;
                    // before retirement, state income tax
                    if (age < this.data.person.retirement.age) {
                        stateTax = taxableOrdinaryIncome * (this.data.tax.state.beforeRetirement / 100);
                    } else {
                        stateTax = taxableOrdinaryIncome * (this.data.tax.state.afterRetirement / 100);
                    }
                    tax += stateTax;
                    // ==========  end of taxes
                    let medicareBPremium = 0;

                    if (age >= this.data.medicare.age) { // medicare kicks in
                        medicareBPremium = this.getMedicarePremiumsByMagi(taxableOrdinaryIncome + taxableSS, year - 2);
                        medicareBPremium *= 2 * 12; // 2 people for a year
                        spendingAfterSS += medicareBPremium;
                    }

                    let yearly = {
                        age: age,
                        pretaxBalance: pretaxBalance,
                        year: year,
                        salary: salary,
                        k401: k401,
                        roth401k: roth401k,
                        rmd: rmd,
                        dist: dist,
                        investment: investment,
                        roth: roth,
                        tax: tax,
                        spending: spendingAmount,
                        fica: fica,
                        ordinaryIncomeTax: ordinaryIncomeTax,
                        capitalGainTax: capitalGainTax,
                        stateTax: stateTax,
                        title: title,
                        ss: ss,
                        medicare: medicareBPremium
                    };
                    this.data.yearlyData.push(yearly);

                    /// calculate for next year
                    age++;
                    year++;
                    roth = roth + dist + roth401k;

                    // before retirement, investment balance += salary-spending
                    if (age < this.data.person.retirement.age) {
                        investment += (taxableEarnedIncome - roth401k - spendingAfterSS - tax);
                    }
                    else {
                        // before 59.5, pay tax from investment (otherwise 10% penality)
                        // after that, pay from pretax if there's enough
                        // otherwise pay from the converted roth
                        if (age >= this.data.noPenaltyWithdraw.age) {
                            roth -= (tax + spendingAfterSS);
                        } else {
                            investment -= (tax + spendingAfterSS);
                        }
                    }

                    pretaxBalance = pretaxBalance + k401 - dist;
                    spending.beforeRetirement = spending.beforeRetirement * (1 + this.data.inflation / 100);
                    spending.afterRetirement = spending.afterRetirement * (1 + this.data.inflation / 100);
                }

                //console.table(this.data.yearlyData);
            },
            calculateInsuranceSpendingForYear(year) {
                let ins = this.data.spending.insurance;
                for (let y = new Date().getFullYear() + 1; y <= year; y++) {
                    ins = ins * (1 + this.data.inflation / 100);
                }
                return ins;

            },
            calculateSSBenefits(age) {
                if (age < this.data.person.ss.age) {
                    return 0;
                }

                let yearlySs = this.data.person.ss.perMonth * 12;
                for (let i = this.data.person.ss.age + 1; i <= age; i++) {
                    yearlySs = yearlySs * (1 + this.data.inflation / 100);
                }

                return yearlySs;
            },

            /**
             * returns amount of ss taxable based on 'total income/inflow'
             */
            calculateSSToTax(otherIncome, ss) {
                const provisionalIncome = otherIncome + ss / 2;
                if (provisionalIncome < 32000)
                    return 0;
                if (provisionalIncome < 44000)
                    return ss * 0.5;

                //else
                return ss * 0.85;
            },
            getRowTitle(age) {
                let title = '';
                switch (age) {
                    case this.data.person.retirement.age:
                        title = "Retirement starts";
                        break;
                    case this.data.rmd.age:
                        title = "Required Minimum Distribution starts";
                        break;
                    case this.data.medicare.age:
                        title = "Medicare starts";
                        break;
                    case this.data.person.ss.age:
                        title = "Social Security benefit starts";
                        break;
                    case this.data.distribution.age:
                        title = "Roth Conversion starts"
                        break;
                    case this.data.noPenaltyWithdraw.age:
                        title = "Penalty free withdraw from pretax accounts starts, your spendings will be taken from pretax accounts first";
                        break;
                }
                return title;
            },

            calculateCapitalGainTax(age, year, tax, k401kWithdraw, spendingAmount, investment) {
                // before retirement, spending money is from salary, no capital gain
                // after no-penalty withdraw age, take money from roth, no capital gain
                // between retirement age and no-penalty withdraw age 59.5
                //  spending money will be paid from investment account first, which has 15% tax,
                //  plus 3.8% medicare surtax on 250k above capital gain
                // if investment account has no money, pay tax from roth, which has no tax TODO ASSUMPTION: there's enough contribution into roth to take out without penalty
                if (age < this.data.person.retirement.age) { // TODO ASSUMPTION: salary covers all spending
                    return 0;
                }
                if (age >= this.data.noPenaltyWithdraw.age) { // age > 59.5, take money from pretax ira
                    return 0;
                }

                // age between retirement and no-penalty withdraw age (59.5)
                const investmentWithdraws = (spendingAmount + tax + spendingAmount * 0.15) / 2; // TODO assumption: capital gain = 50% of funds sold
                const taxable = k401kWithdraw + investmentWithdraws; // assuming all taken from investment

                if (investment < investmentWithdraws) {
                    return 0;  // take money from roth, no tax TODO ASSUMPTION: there's enough contribution into roth to take out without penalty
                }

                let newTax = 0;
                const noTaxCeiling = this.getCapitalGain0TaxCeiling(year);
                if (taxable > noTaxCeiling) {
                    newTax += investmentWithdraws * 0.15;  // 15% capital gain
                } // otheriwse
                if (taxable > 250000) {     // apply additional 3.8% medicare surtax on net investment gain tax
                    if (k401kWithdraw >= 250000) {
                        newTax += (investmentWithdraws - 250000) * 0.038;
                    } else {
                        newTax += (250000 - k401kWithdraw + investmentWithdraws) * 0.038;
                    }
                }
                newTax += investmentWithdraws * (this.data.tax.state.afterRetirement / 100); // state tax for capital gain
                return newTax;

            },

            getCapitalGain0TaxCeiling(year) {
                const ceilingInreaseRate = 0.045; // using ssrCeilingInreaseRate
                const ceiling2025 = 96700;
                let newCeiling = ceiling2025;
                for (let i = 0; i < year - 2025; i++) {
                    newCeiling = newCeiling * (1 + ceilingInreaseRate);
                }
                return newCeiling;
            },
            // Util functions
            toDollar(val) {
                return new Intl.NumberFormat("en-US", {
                    style: "currency",
                    currency: "USD",
                }).format(val);
            },
            toPercent(val) {
                return new Intl.NumberFormat("en-US", {
                    style: "percent",
                    maximumFractionDigits: 1,
                }).format(val / 100);
            },
            getMedicarePremiumsByMagi(magi, year) {
                const premiums = this.getMedicarePremiumsForYear(year);

                let premium = premiums.data[0].monthly;
                for (let p of premiums.data) {
                    if (magi >= p.ceiling) {
                        premium = p.monthly;
                        break;
                    }
                }
                return premium;
            },
            getMedicarePremiumsForYear(year) {
                if (!this.data.medicare.premiums || this.data.medicare.premiums.length === 0) {
                    this.estimateMedicarePremiumsforAllYears();
                }
                const premiums = this.data.medicare.premiums.find(y => y.year === year);
                return premiums;
            },
            estimateMedicarePremiumsforAllYears() {
                //calculate part b only
                // increase rate = 6.5%  // https://www.statista.com/statistics/1284023/annual-percentage-change-of-medicare-part-b-premium-us/
                const premiumIncreaseRate = 0.065;
                const ceilingIncreaseRate = 0.039; // average of last 5 years

                // ceiling increase rate ~3.9%
                //premium2025
                const premium2025 = [
                    { ceiling: 212000, monthly: 185 },
                    { ceiling: 266000, monthly: 259 },
                    { ceiling: 344000, monthly: 370 },
                    { ceiling: 400000, monthly: 480.9 },
                    { ceiling: 750000, monthly: 591.9 },
                    { ceiling: 1000000, monthly: 628.9 }
                ];
                this.data.medicare.premiums.push({
                    year: 2025,
                    data: premium2025
                });

                const deceaseYear = (new Date()).getFullYear() + (this.data.person.deceased.age - this.data.person.age);
                for (let i = this.data.medicare.premiums[0].year + 1; i < deceaseYear; i++) {
                    const previousPremium = this.data.medicare.premiums.find(x => x.year == i - 1).data;
                    const newPremium = previousPremium.map(x => { return { ceiling: x.ceiling * (1 + ceilingIncreaseRate), monthly: x.monthly * (1 + premiumIncreaseRate) } });
                    this.data.medicare.premiums.push({
                        year: i,
                        data: newPremium
                    });
                }
                console.log('medicare premiums: ', this.data.medicare.premiums);
            },
            getTaxBracketsForYear(year) {
                this.calculateTaxBracketsForAllYear(year);
                try {
                    return this.data.tax.brackets.find(x => x.year === year);
                } catch (ex) {
                    console.error('year=', year, 'ex=', ex);
                }
            },
            calculateTaxBracketsForAllYear(year) {
                if (this.data.tax.brackets && this.data.tax.brackets.length !== 0) {
                    return;
                }

                // historical yearly bracket increase around 1.6% in from 2007-2017
                const r = 0.016;

                const b2025Data = [
                    { percent: 12, income: 96950 },
                    { percent: 22, income: 206700 },
                    { percent: 24, income: 394600 },
                    { percent: 32, income: 501050 },
                    { percent: 35, income: 751600 },
                    { percent: 37, income: 1000000 }
                ];

                const b2025 = {
                    year: 2025,
                    standardDeduction: 30000,
                    data: b2025Data
                }

                this.data.tax.brackets = [b2025];
                let extra65standardDeduction = 3100;  // 2025 extra was 3100, it will get adjusted at the same rate as tax brackets
                for (let i = 2026; i < 2026 + this.data.person.deceased.age; i++) {
                    const newdata = this.data.tax.brackets[this.data.tax.brackets.length - 1].data.map(
                        x => { return { percent: x.percent, income: Math.round(x.income * (1 + r)) } }
                    );
                    let standardDeduction = this.data.tax.brackets[this.data.tax.brackets.length - 1].standardDeduction * (1 + r);

                    // if 65, add 65 extra standard deduction for one year, then following years will be based on 65
                    const age = this.data.person.age + (year - (new Date().getFullYear()));
                    if (i > 2025 & age <= 65) {
                        extra65standardDeduction *= (1 + r);
                        if (age === 65) {
                            standardDeduction += extra65standardDeduction;
                        }
                    }

                    this.data.tax.brackets.push({
                        year: i,
                        standardDeduction: standardDeduction,
                        data: newdata
                    })
                }
            },
            /**
             * returns ordinary income upper limit for given year and bracket
             * if bracket is not found, go with the bracket lower
             */
            getIncomeForBracketAndYear(year, bracketRate) {
                if (bracketRate === '0') return 0;    // not selected in dropdown

                const brackets = this.getTaxBracketsForYear(year).data;
                let bracket = brackets.find(x => x.percent === bracketRate);
                if (bracket == null) {
                    let i = 0;
                    for (i = 0; i < brackets.length; i++) {
                        if (brackets[i].percent > bracketRate)
                            break;
                    }
                    bracket = brackets[i + 1];
                }
                return bracket.income;
            },
            calculateOrdinaryIncomeTaxForYear(income, year) {
                const taxData = this.getTaxBracketsForYear(year);
                const brackets = taxData.data;
                const standardDeduction = taxData.standardDeduction > income ? income : taxData.standardDeduction;

                income = income - standardDeduction;
                let sum = 0;
                for (let i = 0; i < brackets.length; i++) {
                    const bracket = brackets[i];
                    if (income > bracket.income) {
                        let tax = bracket.percent / 100 * bracket.income;
                        sum += tax;
                        income = income - bracket.income;
                    } else {
                        let tax = bracket.percent / 100 * income;
                        sum += tax;
                        return sum;
                    }
                }
            },
            calculateFica(salary, year) {
                const ssRate = 0.062;
                const medicareRate = 0.0145, medicareCeiling = 250000, medicareRateOverCeiling = 0.0235;
                const ssTaxCeiling = this.getFica_SSTaxCeiling(year);
                let fica = 0;
                if (salary > ssTaxCeiling) {
                    fica += ssTaxCeiling * ssRate;
                } else {
                    fica += salary * ssRate;
                }

                if (salary <= medicareCeiling) {
                    fica += salary * medicareRate;
                } else {
                    fica += medicareCeiling * medicareRate;
                    fica += (salary - medicareCeiling) * medicareRateOverCeiling;
                }
                return fica;
            },
            getFica_SSTaxCeiling(year) {
                const ssrCeiling2025 = 176100;       // fica is calculated up to this number
                const ssrCeilingInreaseRate = 0.045; // average from last 8 years

                let sum = ssrCeiling2025;
                for (let i = 0; i < year - 2025; i++) {
                    sum = sum * (1 + ssrCeilingInreaseRate);
                }
                return sum;
            }
        },
        beforeMount() {
            try {
                this.calculate();
            } catch (ex) {
                console.error(ex);
            }
        }
    }).mount("#app");
    app.config.globalProperties.window = window;
</script>
<details>
    <summary>TODOs</summary>
    <ol>
        <li>add calculation for Singler filer, and other types</li>
        <li>before retirement, if started conversion, and salary doesn't cover tax, need to take tax out of investment
        </li>
        <li>different state capital gain tax from ordinary</li>
        <li>custom % conversion</li>
        <li>spouse</li>
        <li>today's currency view</li>
        <li>one-off expenses & income</li>
    </ol>
</details>